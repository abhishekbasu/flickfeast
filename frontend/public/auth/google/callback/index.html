<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signing in...</title>
  </head>
  <body>
    <p>Completing sign in...</p>
    <script>
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const error = params.get("error");

      const backendOrigin = window.location.origin.includes("localhost:5173")
        ? "http://localhost:8000"
        : window.location.origin;

      if (error) {
        document.body.textContent = `Login failed: ${error}`;
      } else if (!code) {
        document.body.textContent = "Missing authorization code.";
      } else {
        fetch(`${backendOrigin}/auth/google/callback?code=${encodeURIComponent(code)}`)
          .then(async (res) => {
            const contentType = res.headers.get("content-type") || "";
            const bodyText = await res.text();
            if (!res.ok) {
              throw new Error(bodyText || "Auth failed");
            }
            if (!contentType.includes("application/json")) {
              throw new Error(bodyText || "Unexpected response");
            }
            return JSON.parse(bodyText);
          })
          .then((data) => {
            if (!data || !data.email) {
              throw new Error("Invalid auth response");
            }
            localStorage.setItem("ff_user", JSON.stringify(data));
            window.location.href = "/";
          })
          .catch((err) => {
            document.body.textContent = `Login failed. ${err.message || ""}`;
          });
      }
    </script>
  </body>
</html>
